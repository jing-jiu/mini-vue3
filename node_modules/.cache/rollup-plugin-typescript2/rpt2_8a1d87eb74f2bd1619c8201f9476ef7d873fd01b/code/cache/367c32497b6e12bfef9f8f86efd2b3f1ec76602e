{"code":"import { isArray, isIntegerKey } from \"@vue/shared\";\r\nexport function effect(fn, options = {}) {\r\n    const _effect = createReactiveEffect(fn, options);\r\n    if (!options.lazy) {\r\n        _effect();\r\n    }\r\n    return _effect;\r\n}\r\nlet uid = 0, effectStack = [], activeEffect = undefined;\r\nfunction createReactiveEffect(fn, options) {\r\n    const effect = function reactiveEffect() {\r\n        if (!effectStack.includes(effect)) {\r\n            try {\r\n                effectStack.push(effect);\r\n                activeEffect = effect;\r\n                return fn();\r\n            }\r\n            finally {\r\n                effectStack.pop();\r\n                activeEffect = effectStack[effectStack.length - 1];\r\n            }\r\n        }\r\n    };\r\n    effect.id = uid++;\r\n    effect.isEffect = true;\r\n    effect.raw = fn; // 记录原本的fn\r\n    effect.deps = []; // 收集依赖\r\n    effect.options = options;\r\n    return effect;\r\n}\r\nconst targetMap = new WeakMap();\r\nexport function track(target, type, key) {\r\n    // 没有调用effect 就不用记录\r\n    if (activeEffect === undefined) {\r\n        return;\r\n    }\r\n    // 创建收集依赖的map\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map));\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set));\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect);\r\n        activeEffect.deps.push(dep);\r\n    }\r\n}\r\nexport function trigger(target, type, key, newValue, oldValue) {\r\n    const depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        return;\r\n    }\r\n    console.log(depsMap);\r\n    const effects = new Set();\r\n    const add = (effectToAdd) => {\r\n        if (effectToAdd) {\r\n            effectToAdd.forEach(effect => {\r\n                effects.add(effect);\r\n            });\r\n        }\r\n    };\r\n    if (key === \"length\" && isArray(target)) {\r\n        // 如果修改的属性是数组的长度\r\n        depsMap.forEach((dep, key) => {\r\n            if (key === \"length\" || key >= newValue) {\r\n                // 有长度的依赖和新设置的值小于key\r\n                add(dep);\r\n            }\r\n        });\r\n    }\r\n    else {\r\n        if (key !== void 0) {\r\n            add(depsMap.get(key));\r\n        }\r\n        switch (type) {\r\n            case \"TriggerOpTypes.ADD\":\r\n                if (isArray(target)) {\r\n                    if (isIntegerKey(key)) {\r\n                        // 给数组新增书属性 触发length\r\n                        add(depsMap.get(\"length\"));\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n    effects.forEach((effect) => {\r\n        effect();\r\n    });\r\n}\r\n//# sourceMappingURL=effect.js.map","references":["C:/Users/惠新浩/Desktop/Task/Web/Vue/手写vue/vue3/packages/shared/src/index.ts"],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
