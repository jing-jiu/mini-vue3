{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (value: any) => typeof value === \"object\" && value !== null;\r\n\r\nexport const isArray = Array.isArray\r\n\r\nexport const isString = (val: unknown): val is string => typeof val === 'string'\r\n\r\nexport const isIntegerKey = (key: unknown) =>\r\n    isString(key) &&\r\n    key !== 'NaN' &&\r\n    key[0] !== '-' &&\r\n    '' + parseInt(key, 10) === key\r\n\r\nconst hasOwnProperty = Object.prototype.hasOwnProperty\r\n\r\nexport const hasOwn = (\r\n    val: object,\r\n    key: string | symbol\r\n): key is keyof typeof val => hasOwnProperty.call(val, key)\r\n\r\nexport const hasChanged = (value: any, oldValue: any): boolean =>\r\n    !Object.is(value, oldValue)","import { isArray, isIntegerKey } from \"@vue/shared\"\r\nimport { TriggerOpTypes } from \"./operators\"\r\n\r\nexport function effect(fn, options: any = {}) {\r\n    const _effect = createReactiveEffect(fn, options)\r\n    if (!options.lazy) {\r\n        _effect()\r\n    }\r\n    return _effect\r\n}\r\n\r\nlet uid = 0, effectStack = [], activeEffect = undefined\r\nfunction createReactiveEffect(fn, options) {\r\n    const effect = function reactiveEffect() {\r\n        if (!effectStack.includes(effect)) {\r\n            try {\r\n                effectStack.push(effect)\r\n                activeEffect = effect\r\n                return fn()\r\n            } finally {\r\n                effectStack.pop()\r\n                activeEffect = effectStack[effectStack.length - 1]\r\n            }\r\n        }\r\n    }\r\n    effect.id = uid++\r\n    effect.isEffect = true\r\n    effect.raw = fn // 记录原本的fn\r\n    effect.deps = [] // 收集依赖\r\n    effect.options = options\r\n    return effect\r\n}\r\n\r\nconst targetMap = new WeakMap()\r\n\r\nexport function track(target, type, key) {\r\n    // 没有调用effect 就不用记录\r\n    if (activeEffect === undefined) {\r\n        return\r\n    }\r\n    // 创建收集依赖的map\r\n    let depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map))\r\n    }\r\n    let dep = depsMap.get(key)\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set))\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect)\r\n        activeEffect.deps.push(dep)\r\n    }\r\n}\r\n\r\nexport function trigger(target, type, key?, newValue?, oldValue?) {\r\n    const depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        return\r\n    }\r\n\r\n    const effects = new Set()\r\n    const add = (effectToAdd) => {\r\n        if (effectToAdd) {\r\n            effectToAdd.forEach(effect => {\r\n                effects.add(effect)\r\n            });\r\n        }\r\n    }\r\n    // 如果修改的是数组的length\r\n    if (key === \"length\" && isArray(target)) {\r\n        depsMap.forEach((dep, key) => { \r\n            if (key === \"length\" || key >= newValue) {\r\n                // 更改的长度小于收集的索引 \r\n                add(dep)\r\n            }\r\n        });\r\n    } else {\r\n        if (key !== void 0) {\r\n            add(depsMap.get(key))\r\n        }\r\n        switch (type) {\r\n            case TriggerOpTypes.ADD:\r\n                if (isArray(target)) {\r\n                    if (isIntegerKey(key)) {\r\n                        // 给数组新增书属性 触发length\r\n                        add(depsMap.get(\"length\"))\r\n                    }\r\n                }\r\n                break;\r\n\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n    effects.forEach((effect: any) => {\r\n        effect()\r\n    })\r\n}","import { isArray, isObject, hasOwn, isIntegerKey, hasChanged } from \"@vue/shared\"\r\nimport { track, trigger } from \"./effect\"\r\nimport { TrackOpTypes, TriggerOpTypes } from \"./operators\"\r\nimport { reactive, readonly } from \"./reactive\"\r\n\r\nconst get = createGetter()\r\nconst shallowGet = createGetter(false, true)\r\nconst readonlyGet = createGetter(true)\r\nconst shallowReadonlyGet = createGetter(true, true)\r\n\r\nconst set = createSetter()\r\nconst shallowSet = createSetter(true)\r\n\r\n\r\n\r\n\r\n/**\r\n * \r\n * @param isReadonly 是否只读\r\n * @param shallow  是否浅相应\r\n */\r\nfunction createGetter(isReadonly = false, shallow = false) {\r\n    return function get(target, key, receiver) {\r\n        const res = Reflect.get(target, key, receiver)\r\n\r\n        if (!isReadonly) {\r\n            // 可写的才收集依赖\r\n            console.log(\"收集依赖\", key);\r\n            track(target, TrackOpTypes.GET, key)\r\n        }\r\n        if (shallow) {\r\n            // 浅响应不用返回代理\r\n            return res\r\n        }\r\n        if (isObject(res)) {\r\n            // 结果是对象 判断对象响应式的状态 进行不同的处理\r\n            return isReadonly ? readonly(res) : reactive(res)\r\n        }\r\n        return res\r\n    }\r\n}\r\n\r\nfunction createSetter(shallow = false) {\r\n    return function set(target, key, value, receiver) {\r\n        const oldValue = target[key]\r\n\r\n        // 判断新增还是修改\r\n        const hadKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)\r\n\r\n        const result = Reflect.set(target, key, value, receiver)\r\n        if (!hadKey) {\r\n            // 新增属性\r\n            trigger(target, TriggerOpTypes.ADD, key, value)\r\n        } else if (hasChanged(value, oldValue)) {\r\n            // 修改属性\r\n            trigger(target, TriggerOpTypes.SET, key, value, oldValue)\r\n        }\r\n        return result\r\n    }\r\n}\r\n\r\n\r\nexport const mutableHandlers = {\r\n    get, set\r\n}\r\nexport const shallowReactiveHandlers = {\r\n    get: shallowGet,\r\n    set: shallowSet\r\n}\r\n\r\nexport const readonlyHandlers = {\r\n    get: readonlyGet,\r\n    set(target, key) {\r\n        console.warn(`Set operation on key \"${String(key)}\" failed: target is readonly.`)\r\n        return true;\r\n    }\r\n}\r\n\r\nexport const shallowReadonlyHandlers = {\r\n    get: shallowReadonlyGet,\r\n    set(target, key) {\r\n        console.warn(`Set operation on key \"${String(key)}\" failed: target is readonly.`)\r\n        return true;\r\n    }\r\n}","import { isObject } from \"@vue/shared\"\r\nimport {\r\n    mutableHandlers,\r\n    shallowReactiveHandlers,\r\n    readonlyHandlers,\r\n    shallowReadonlyHandlers\r\n} from \"./baseHandlers\"\r\n\r\n\r\n\r\nexport function reactive(target) {\r\n    return createReactiveObject(target, false, mutableHandlers)\r\n}\r\n\r\nexport function shallowReactive(target) {\r\n    return createReactiveObject(target, false, shallowReactiveHandlers)\r\n}\r\n\r\nexport function readonly(target) {\r\n    return createReactiveObject(target, true, readonlyHandlers)\r\n}\r\n\r\nexport function shallowReadonly(target) {\r\n    return createReactiveObject(target, true, shallowReadonlyHandlers)\r\n}\r\n\r\n// 是不是只读 是不是深度----> 柯里化\r\n\r\n// 一个对象可能被多个代理  深度代理 + 仅读代理\r\nconst reactiveMap = new WeakMap();\r\nconst readonlyMap = new WeakMap();\r\n\r\n/**\r\n * \r\n * @param target 拦截的目标\r\n * @param isReadonly 是不是仅读属性\r\n * @param baseHandlers 对应的拦截函数\r\n */\r\nexport function createReactiveObject(target, isReadonly: boolean, baseHandlers) {\r\n    if (!isObject(target)) {\r\n        return target\r\n    }\r\n\r\n    // 被代理过了就不需要再次代理\r\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap\r\n\r\n    const exisitProxy = proxyMap.get(target)\r\n    if (exisitProxy) {\r\n        return exisitProxy\r\n    }\r\n    const proxy = new Proxy(target, baseHandlers)\r\n    proxyMap.set(target, proxy)\r\n\r\n    return proxy\r\n}\r\n "],"names":[],"mappings":"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"}