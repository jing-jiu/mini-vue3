{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (value: any) => typeof value === \"object\" && value !== null;\r\n\r\nexport const isArray = Array.isArray\r\n\r\nexport const isString = (val: unknown): val is string => typeof val === 'string'\r\n\r\nexport const isIntegerKey = (key: unknown) =>\r\n    isString(key) &&\r\n    key !== 'NaN' &&\r\n    key[0] !== '-' &&\r\n    '' + parseInt(key, 10) === key\r\n\r\nconst hasOwnProperty = Object.prototype.hasOwnProperty\r\n\r\nexport const hasOwn = (\r\n    val: object,\r\n    key: string | symbol\r\n): key is keyof typeof val => hasOwnProperty.call(val, key)\r\n\r\nexport const hasChanged = (value: any, oldValue: any): boolean =>\r\n    !Object.is(value, oldValue)","import { isArray, isIntegerKey } from \"@vue/shared\"\r\nimport { TriggerOpTypes } from \"./operators\"\r\n\r\nexport function effect(fn, options: any = {}) {\r\n    const _effect = createReactiveEffect(fn, options)\r\n    if (!options.lazy) {\r\n        _effect()\r\n    }\r\n    return _effect\r\n}\r\n\r\nlet uid = 0, effectStack = [], activeEffect = undefined\r\nfunction createReactiveEffect(fn, options) {\r\n    const effect = function reactiveEffect() {\r\n        if (!effectStack.includes(effect)) {\r\n            try {\r\n                effectStack.push(effect)\r\n                activeEffect = effect\r\n                return fn()\r\n            } finally {\r\n                effectStack.pop()\r\n                activeEffect = effectStack[effectStack.length - 1]\r\n            }\r\n        }\r\n    }\r\n    effect.id = uid++\r\n    effect.isEffect = true\r\n    effect.raw = fn // 记录原本的fn\r\n    effect.deps = [] // 收集依赖\r\n    effect.options = options\r\n    return effect\r\n}\r\n\r\nconst targetMap = new WeakMap()\r\n\r\nexport function track(target, type, key) {\r\n    // 没有调用effect 就不用记录\r\n    if (activeEffect === undefined) {\r\n        return\r\n    }\r\n    // 创建收集依赖的map\r\n    let depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map))\r\n    }\r\n    let dep = depsMap.get(key)\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set))\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect)\r\n        activeEffect.deps.push(dep)\r\n    }\r\n}\r\n\r\nexport function trigger(target, type, key?, newValue?, oldValue?) {\r\n    const depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        return\r\n    }\r\n\r\n    const effects = new Set()\r\n    const add = (effectToAdd) => {\r\n        if (effectToAdd) {\r\n            effectToAdd.forEach(effect => {\r\n                effects.add(effect)\r\n            });\r\n        }\r\n    }\r\n    // 如果修改的是数组的length\r\n    if (key === \"length\" && isArray(target)) {\r\n        depsMap.forEach((dep, key) => { \r\n            if (key === \"length\" || key >= newValue) {\r\n                // 更改的长度小于收集的索引 \r\n                add(dep)\r\n            }\r\n        });\r\n    } else {\r\n        if (key !== void 0) {\r\n            add(depsMap.get(key))\r\n        }\r\n        switch (type) {\r\n            case TriggerOpTypes.ADD:\r\n                if (isArray(target)) {\r\n                    if (isIntegerKey(key)) {\r\n                        // 给数组新增书属性 触发length\r\n                        add(depsMap.get(\"length\"))\r\n                    }\r\n                }\r\n                break;\r\n\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n    effects.forEach((effect: any) => {\r\n        effect()\r\n    })\r\n}","import { isArray, isObject, hasOwn, isIntegerKey, hasChanged } from \"@vue/shared\"\r\nimport { track, trigger } from \"./effect\"\r\nimport { TrackOpTypes, TriggerOpTypes } from \"./operators\"\r\nimport { reactive, readonly } from \"./reactive\"\r\n\r\nconst get = createGetter()\r\nconst shallowGet = createGetter(false, true)\r\nconst readonlyGet = createGetter(true)\r\nconst shallowReadonlyGet = createGetter(true, true)\r\n\r\nconst set = createSetter()\r\nconst shallowSet = createSetter(true)\r\n\r\n\r\n\r\n\r\n/**\r\n * \r\n * @param isReadonly 是否只读\r\n * @param shallow  是否浅相应\r\n */\r\nfunction createGetter(isReadonly = false, shallow = false) {\r\n    return function get(target, key, receiver) {\r\n        const res = Reflect.get(target, key, receiver)\r\n\r\n        if (!isReadonly) {\r\n            // 可写的才收集依赖\r\n            console.log(\"收集依赖\", key);\r\n            track(target, TrackOpTypes.GET, key)\r\n        }\r\n        if (shallow) {\r\n            // 浅响应不用返回代理\r\n            return res\r\n        }\r\n        if (isObject(res)) {\r\n            // 结果是对象 判断对象响应式的状态 进行不同的处理\r\n            return isReadonly ? readonly(res) : reactive(res)\r\n        }\r\n        return res\r\n    }\r\n}\r\n\r\nfunction createSetter(shallow = false) {\r\n    return function set(target, key, value, receiver) {\r\n        const oldValue = target[key]\r\n\r\n        // 判断新增还是修改\r\n        const hadKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)\r\n\r\n        const result = Reflect.set(target, key, value, receiver)\r\n        if (!hadKey) {\r\n            // 新增属性\r\n            trigger(target, TriggerOpTypes.ADD, key, value)\r\n        } else if (hasChanged(value, oldValue)) {\r\n            // 修改属性\r\n            trigger(target, TriggerOpTypes.SET, key, value, oldValue)\r\n        }\r\n        return result\r\n    }\r\n}\r\n\r\n\r\nexport const mutableHandlers = {\r\n    get, set\r\n}\r\nexport const shallowReactiveHandlers = {\r\n    get: shallowGet,\r\n    set: shallowSet\r\n}\r\n\r\nexport const readonlyHandlers = {\r\n    get: readonlyGet,\r\n    set(target, key) {\r\n        console.warn(`Set operation on key \"${String(key)}\" failed: target is readonly.`)\r\n        return true;\r\n    }\r\n}\r\n\r\nexport const shallowReadonlyHandlers = {\r\n    get: shallowReadonlyGet,\r\n    set(target, key) {\r\n        console.warn(`Set operation on key \"${String(key)}\" failed: target is readonly.`)\r\n        return true;\r\n    }\r\n}","import { isObject } from \"@vue/shared\"\r\nimport {\r\n    mutableHandlers,\r\n    shallowReactiveHandlers,\r\n    readonlyHandlers,\r\n    shallowReadonlyHandlers\r\n} from \"./baseHandlers\"\r\n\r\n\r\n\r\nexport function reactive(target) {\r\n    return createReactiveObject(target, false, mutableHandlers)\r\n}\r\n\r\nexport function shallowReactive(target) {\r\n    return createReactiveObject(target, false, shallowReactiveHandlers)\r\n}\r\n\r\nexport function readonly(target) {\r\n    return createReactiveObject(target, true, readonlyHandlers)\r\n}\r\n\r\nexport function shallowReadonly(target) {\r\n    return createReactiveObject(target, true, shallowReadonlyHandlers)\r\n}\r\n\r\n// 是不是只读 是不是深度----> 柯里化\r\n\r\n// 一个对象可能被多个代理  深度代理 + 仅读代理\r\nconst reactiveMap = new WeakMap();\r\nconst readonlyMap = new WeakMap();\r\n\r\n/**\r\n * \r\n * @param target 拦截的目标\r\n * @param isReadonly 是不是仅读属性\r\n * @param baseHandlers 对应的拦截函数\r\n */\r\nexport function createReactiveObject(target, isReadonly: boolean, baseHandlers) {\r\n    if (!isObject(target)) {\r\n        return target\r\n    }\r\n\r\n    // 被代理过了就不需要再次代理\r\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap\r\n\r\n    const exisitProxy = proxyMap.get(target)\r\n    if (exisitProxy) {\r\n        return exisitProxy\r\n    }\r\n    const proxy = new Proxy(target, baseHandlers)\r\n    proxyMap.set(target, proxy)\r\n\r\n    return proxy\r\n}\r\n "],"names":[],"mappings":"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"}